-- Test cases concerning row count calculations.
--
CREATE TABLE t1 (s1 VARCHAR(10) PRIMARY KEY)
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
CREATE TABLE t2 (s1 VARCHAR(10) PRIMARY KEY, s2 VARCHAR(10) REFERENCES t1 \
    ON DELETE CASCADE)
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
CREATE TABLE t3 (i1 INT UNIQUE, i2 INT, i3 INT PRIMARY KEY)
---
- row_count: 1
...
INSERT INTO t3 VALUES (0, 0, 0)
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
CREATE TRIGGER x AFTER DELETE ON t1 FOR EACH ROW \
BEGIN                                            \
    UPDATE t3 SET i1 = i1 + ROW_COUNT();         \
END
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
INSERT INTO t1 VALUES ('a')
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
INSERT INTO t2 VALUES ('a','a')
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
INSERT INTO t1 VALUES ('b'), ('c'), ('d')
---
- row_count: 3
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [3]
...
-- REPLACE is accounted for two operations: DELETE + INSERT.
REPLACE INTO t2 VALUES('a', 'c')
---
- row_count: 2
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [2]
...
DELETE FROM t1
---
- row_count: 4
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [4]
...
INSERT INTO t3 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3)
---
- row_count: 3
...
TRUNCATE TABLE t3
---
- row_count: 0
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
INSERT INTO t3 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3)
---
- row_count: 3
...
UPDATE t3 SET i2 = 666
---
- row_count: 3
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [3]
...
-- gh-3816: DELETE optimization returns valid number of
-- deleted tuples.
--
DELETE FROM t3 WHERE 0 = 0
---
- row_count: 3
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [3]
...
INSERT INTO t3 VALUES (1, 1, 1), (2, 2, 2), (3, 3, 3)
---
- row_count: 3
...
DELETE FROM t3
---
- row_count: 3
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [3]
...
-- But triggers still should't be accounted.
--
CREATE TABLE tt1 (id INT PRIMARY KEY)
---
- row_count: 1
...
CREATE TABLE tt2 (id INT PRIMARY KEY)
---
- row_count: 1
...
CREATE TRIGGER tr1 AFTER DELETE ON tt1 FOR EACH ROW \
BEGIN                                               \
    DELETE FROM tt2;                                \
END
---
- row_count: 1
...
INSERT INTO tt1 VALUES (1), (2), (3)
---
- row_count: 3
...
INSERT INTO tt2 VALUES (1), (2), (3)
---
- row_count: 3
...
DELETE FROM tt1 WHERE id = 2
---
- row_count: 1
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [1]
...
SELECT * FROM tt2
---
- metadata:
  - name: ID
    type: integer
  rows: []
...
DROP TABLE tt1
---
- row_count: 1
...
DROP TABLE tt2
---
- row_count: 1
...
-- All statements which are not accounted as DML should
-- return 0 (zero) as a row count.
--
START TRANSACTION
---
- row_count: 0
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
COMMIT
---
- row_count: 0
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
COMMIT
---
- error: 'Failed to execute SQL statement: cannot commit - no transaction is active'
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
-- ANALYZE
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
EXPLAIN QUERY PLAN INSERT INTO t1 VALUES ('b'), ('c'), ('d')
---
- metadata:
  - name: selectid
    type: INTEGER
  - name: order
    type: INTEGER
  - name: from
    type: INTEGER
  - name: detail
    type: TEXT
  rows:
  - [0, 0, 0, 'SCAN TABLE T2 (~262144 rows)']
...
SELECT ROW_COUNT()
---
- metadata:
  - name: ROW_COUNT()
    type: integer
  rows:
  - [0]
...
PRAGMA recursive_triggers
---
- metadata:
  - name: recursive_triggers
    type: INTEGER
  rows:
  - [1]
...
-- Clean-up.
--
DROP TABLE t2
---
- row_count: 1
...
DROP TABLE t3
---
- row_count: 1
...
DROP TABLE t1
---
- row_count: 1
...
